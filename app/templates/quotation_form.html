{% extends "layout.html" %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-7">
                <h2 class="mb-4">
                    {% if revise_source_id %}
                        見積改定（元見積ID: {{ revise_source_id }}）
                    {% else %}
                        見積新規作成
                    {% endif %}
                </h2>
            </div>
            <div class="mb-3">
                <label for="company_name" class="form-label">宛先企業名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="company_name" name="company_name" required value="{{ values.company_name }}">
            </div>
            <div class="mb-3">
                <label for="contact_name" class="form-label">宛先担当者名</label>
                <input type="text" class="form-control" id="contact_name" name="contact_name" value="{{ values.contact_name }}">
            </div>
            <div class="mb-3">
                <label for="project_name" class="form-label">案件名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="project_name" name="project_name" required value="{{ values.project_name }}">
            </div>
            <div class="mb-3">
                <label for="delivery_date" class="form-label">納期</label>
                <input type="text" class="form-control" id="delivery_date" name="delivery_date" value="{{ values.delivery_date }}">
            </div>
            <div class="mb-3">
                <label for="delivery_terms" class="form-label">引渡条件</label>
                <input type="text" class="form-control" id="delivery_terms" name="delivery_terms" value="{{ values.delivery_terms }}">
            </div>
            <div class="mb-3">
                <h5>自動計算プレビュー（詳細）</h5>
                <div>・設計費（概算）: <span id="preview-design-fee">0</span> 円</div>
                <div>&nbsp;&nbsp;┗ 設計工数: <span id="preview-design-hours">0.0</span> h</div>
                <div>&nbsp;&nbsp;┗ 設計原価: <span id="preview-design-cost">0</span> 円</div>
                <div>&nbsp;&nbsp;┗ 設計費利益率: <span id="preview-design-profit-rate">0.0%</span></div>
                <div class="mt-2">・現地セットアップ費（概算）: <span id="preview-setup-fee">0</span> 円</div>
                <div>&nbsp;&nbsp;┗ セットアップ工数: <span id="preview-setup-hours">0.0</span> h</div>
                <div>&nbsp;&nbsp;┗ セットアップ原価: <span id="preview-setup-cost">0</span> 円</div>
                <div>&nbsp;&nbsp;┗ セットアップ利益率: <span id="preview-setup-profit-rate">0.0%</span></div>
                <hr>
                <div><strong>合計売価（製品＋設計＋セットアップ）:</strong> <span id="preview-total-sell">0</span> 円</div>
                <div><strong>合計原価:</strong> <span id="preview-total-cost">0</span> 円</div>
                <div><strong>最終売価:</strong> <span id="preview-final-sell">0</span> 円</div>
                <div><strong>最終利益率:</strong> <span id="preview-total-profit-rate">0.0%</span></div>
            </div>

            <div class="mt-3 border rounded p-3">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <label for="discount_rate" class="form-label mb-0">値引率</label>
                    </div>
                    <div class="col-auto">
                        <input
                            type="number"
                            class="form-control"
                            id="discount_rate"
                            name="discount_rate"
                            min="0"
                            step="0.1"
                            value="{{ values.discount_rate or 0 }}"
                        >
                    </div>
                    <div class="col-auto">
                        <span>%</span>
                    </div>
                    <div class="col-auto">
                        <span>値引き額: <span id="discount-amount">0</span> 円</span>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <!-- DEBUG: form action={{ url_for('quotation.quotation_new') }} method=post -->
                <button type="submit" class="btn btn-primary">保存</button>
                <a href="{{ url_for('quotation.quotation_list') }}" class="btn btn-link">一覧へ戻る</a>
            </div>
        </form>

        <!-- Jinja埋め込みデータをJSONスクリプトとして分離 -->
        <script type="application/json" id="products-json">{{ products|tojson|safe }}</script>
        <script type="application/json" id="customers-meta-json">{{ customers_meta|tojson|safe }}</script>
        <script type="application/json" id="customers-json">{{ customers|tojson|safe }}</script>
        {% if revise_source_id and values and details %}
        <script type="application/json" id="initial-values-json">{{ values|tojson|safe }}</script>
        <script type="application/json" id="initial-details-json">{{ details|tojson|safe }}</script>
        {% endif %}
        <script src="{{ url_for('static', filename='js/quotation_form.js') }}" defer onerror="console.error('Failed to load quotation_form.js'); /* alert('見積計算用JSの読み込みに失敗しました。static/js/quotation_form.js の配置・パスを確認してください。'); */"></script>
    </div>
</div>
{% endblock %}
